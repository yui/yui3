YUI.add("router",function(b){var g=b.HistoryHash,d=b.QueryString,h=b.Array,j=b.Lang,f=b.config.win,a=[],i=[],e="ready";function c(){c.superclass.constructor.apply(this,arguments);}b.Router=b.extend(c,b.Base,{_regexPathParam:/([:*])([\w\-]+)?/g,_regexUrlQuery:/\?([^#]*).*$/,_regexUrlOrigin:/^(?:[^\/#?:]+:\/\/|\/\/)[^\/]*/,initializer:function(l){var k=this;k._html5=k.get("html5");k._routes=[];k._url=k._getURL();k._setRoutes(l&&l.routes?l.routes:k.get("routes"));if(k._html5){k._history=new b.HistoryHTML5({force:true});k._historyEvents=b.after("history:change",k._afterHistoryChange,k);}else{k._historyEvents=b.on("hashchange",k._afterHistoryChange,f,k);}k.publish(e,{defaultFn:k._defReadyFn,fireOnce:true,preventable:false});k.once("initializedChange",function(){b.once("load",function(){setTimeout(function(){k.fire(e,{dispatched:!!k._dispatched});},20);});});a.push(this);},destructor:function(){var k=h.indexOf(a,this);if(k>-1){a.splice(k,1);}this._historyEvents&&this._historyEvents.detach();},dispatch:function(){this.once(e,function(){this._ready=true;if(this._html5&&this.upgrade()){return;}else{this._dispatch(this._getPath(),this._getURL());}});return this;},getPath:function(){return this._getPath();},hasRoute:function(k){var l;if(!this._hasSameOrigin(k)){return false;}if(!this._html5){k=this._upgradeURL(k);}l=this.removeQuery(this.removeRoot(k));return !!this.match(l).length;},match:function(k){return h.filter(this._routes,function(l){return k.search(l.regex)>-1;});},removeRoot:function(l){var k=this.get("root");l=l.replace(this._regexUrlOrigin,"");if(k&&l.indexOf(k)===0){l=l.substring(k.length);}return l.charAt(0)==="/"?l:"/"+l;},removeQuery:function(k){return k.replace(/\?.*$/,"");},replace:function(k){return this._queue(k,true);},route:function(m,l){l=h.flatten(h(arguments,1,true));var k=[];this._routes.push({callbacks:l,keys:k,path:m,regex:this._getRegex(m,k),callback:l[0]});return this;},save:function(k){return this._queue(k);},upgrade:function(){if(!this._html5){return false;}var k=this._getHashPath();if(k){this.once(e,function(){this.replace(k);});return true;}return false;},_decode:function(k){return decodeURIComponent(k.replace(/\+/g," "));},_dequeue:function(){var k=this,l;if(!YUI.Env.windowLoaded){b.once("load",function(){k._dequeue();});return this;}l=i.shift();return l?l():this;},_dispatch:function(s,l,k){var r=this,q=r.match(s),n=[],m,p,o;r._dispatching=r._dispatched=true;if(!q||!q.length){r._dispatching=false;return r;}p=r._getRequest(s,l,k);o=r._getResponse(p);p.next=function(u){var v,t;if(u){if(u==="route"){n=[];p.next();}else{b.error(u);}}else{if((v=n.shift())){if(typeof v==="string"){v=r[v];}p.pendingCallbacks=n.length;v.call(r,p,o,p.next);}else{if((t=q.shift())){n=t.callbacks.concat();m=t.regex.exec(s);if(m.length===t.keys.length+1){p.params=h.hash(t.keys,m.slice(1));}else{p.params=m.concat();}p.pendingRoutes=q.length;p.next();}}}};p.next();r._dispatching=false;return r._dequeue();},_getHashPath:function(k){k||(k=g.getHash());if(k&&k.charAt(0)==="/"){return this._joinURL(k);}return"";},_getOrigin:function(){var k=b.getLocation();return k.origin||(k.protocol+"//"+k.host);},_getPath:function(){var k=(!this._html5&&this._getHashPath())||b.getLocation().pathname;return this.removeQuery(this.removeRoot(k));},_getPathRoot:function(){var l="/",m=b.getLocation().pathname,k;if(m.charAt(m.length-1)===l){return m;}k=m.split(l);k.pop();return k.join(l)+l;},_getQuery:function(){var k=b.getLocation(),m,l;if(this._html5){return k.search.substring(1);}m=g.getHash();l=m.match(this._regexUrlQuery);return m&&l?l[1]:k.search.substring(1);},_getRegex:function(l,k){if(l instanceof RegExp){return l;}if(l==="*"){return(/.*/);}l=l.replace(this._regexPathParam,function(n,m,o){if(!o){return m==="*"?".*":n;}k.push(o);return m==="*"?"(.*?)":"([^/#?]*)";});return new RegExp("^"+l+"$");},_getRequest:function(l,k,m){return{path:l,query:this._parseQuery(this._getQuery()),url:k,src:m};},_getResponse:function(l){var k=function(){return l.next.apply(this,arguments);};k.req=l;return k;},_getRoutes:function(){return this._routes.concat();},_getURL:function(){return b.getLocation().toString();},_hasSameOrigin:function(l){var k=((l&&l.match(this._regexUrlOrigin))||[])[0];if(k&&k.indexOf("//")===0){k=b.getLocation().protocol+k;}return !k||k===this._getOrigin();},_joinURL:function(l){var k=this.get("root");l=this.removeRoot(l);if(l.charAt(0)==="/"){l=l.substring(1);}return k&&k.charAt(k.length-1)==="/"?k+l:k+"/"+l;},_normalizePath:function(s){var p="..",k="/",l,o,r,m,n,q;if(!s||s===k){return k;}m=s.split(k);q=[];for(l=0,o=m.length;l<o;++l){n=m[l];if(n===p){q.pop();}else{if(n){q.push(n);}}}r=k+q.join(k);if(r!==k&&s.charAt(s.length-1)===k){r+=k;}return r;},_parseQuery:d&&d.parse?d.parse:function(n){var o=this._decode,q=n.split("&"),m=0,l=q.length,k={},p;for(;m<l;++m){p=q[m].split("=");if(p[0]){k[o(p[0])]=o(p[1]||"");}}return k;},_queue:function(){var l=arguments,k=this;i.push(function(){if(k._html5){if(b.UA.ios&&b.UA.ios<5){k._save.apply(k,l);}else{setTimeout(function(){k._save.apply(k,l);},1);}}else{k._dispatching=true;k._save.apply(k,l);}return k;});return !this._dispatching?this._dequeue():this;},_resolvePath:function(k){if(!k){return b.getLocation().pathname;}if(k.charAt(0)!=="/"){k=this._getPathRoot()+k;}return this._normalizePath(k);},_resolveURL:function(m){var q=m&&m.match(this._regexURL),l,p,n,o,k;if(!q){return this._getURL();}l=q[1];p=q[2];n=q[3];o=q[4];if(l){if(l.indexOf("//")===0){l=b.getLocation().protocol+l;}return l+(p||"/")+(n||"")+(o||"");}k=this._getOrigin()+this._resolvePath(p);if(p||n){return k+(n||"")+(o||"");}n=this._getQuery();return k+(n?("?"+n):"")+(o||"");},_save:function(m,n){var l=typeof m==="string",o,k;if(l&&!this._hasSameOrigin(m)){b.error("Security error: The new URL must be of the same origin as the current URL.");return this;}l&&(m=this._joinURL(m));this._ready=true;if(this._html5){this._history[n?"replace":"add"](null,{url:m});}else{o=b.getLocation().pathname;k=this.get("root");if(k===o||k===this._getPathRoot()){m=this.removeRoot(m);
}if(m===g.getHash()){b.Router.dispatch();}else{g[n?"replaceHash":"setHash"](m);}}return this;},_setRoutes:function(k){this._routes=[];h.each(k,function(l){var m=l.callbacks||l.callback;this.route(l.path,m);},this);return this._routes.concat();},_upgradeURL:function(l){if(!this._hasSameOrigin(l)){return l;}var n=(l.match(/#(.*)$/)||[])[1]||"",k=b.HistoryHash.hashPrefix,m;if(k&&n.indexOf(k)===0){n=n.replace(k,"");}n&&(m=this._getHashPath(n));if(m){return this._resolveURL(m);}return l;},_afterHistoryChange:function(m){var k=this,o=m.src,l=k._url,n=k._getURL();k._url=n;if(o==="popstate"&&(!k._ready||l.replace(/#.*$/,"")===n.replace(/#.*$/,""))){return;}k._dispatch(k._getPath(),n,o);},_defReadyFn:function(k){this._ready=true;}},{NAME:"router",ATTRS:{html5:{valueFn:function(){return b.Router.html5;},writeOnce:"initOnly"},root:{value:""},routes:{value:[],getter:"_getRoutes",setter:"_setRoutes"}},html5:b.HistoryBase.html5&&(!b.UA.android||b.UA.android>=3),_instances:a,dispatch:function(){var m,k,l;for(m=0,k=a.length;m<k;m+=1){l=a[m];if(l){l._dispatch(l._getPath(),l._getURL());}}}});b.Controller=b.Router;},"@VERSION@",{optional:["querystring-parse"],requires:["array-extras","base-build","history"]});